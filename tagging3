import pandas as pd
import re

# Example DataFrame
data = {
    "subject": [
        "COB - sales report ending with summary",
        "Meeting notes for project",
        "COB - finance update ending with draft",
        "Reminder: submit timesheet",
        "COB - hr policy ending with approval",
        "Meeting follow-up for client",
        "COB - sales report ending with summary",  # duplicate
    ]
}
df = pd.DataFrame(data)
df["tag"] = None  

def progress():
    tagged = df["tag"].notna().sum()
    total = len(df)
    print(f"âœ… Tagged: {tagged} | â³ Left: {total - tagged} | Total: {total}")

def build_pattern(start=None, end=None):
    """Build regex from starting and ending strings"""
    if start and end:
        return rf"^{re.escape(start)}.*{re.escape(end)}$"
    elif start:
        return rf"^{re.escape(start)}.*"
    elif end:
        return rf".*{re.escape(end)}$"
    else:
        return r".*"  # matches everything

def preview_matches(start=None, end=None, top_n=10):
    """Show unique subjects + counts matching start/end pattern"""
    pattern = build_pattern(start, end)
    mask = df["tag"].isna() & df["subject"].str.contains(pattern, flags=re.IGNORECASE, regex=True)
    
    matches = df.loc[mask, "subject"].value_counts().reset_index()
    matches.columns = ["subject", "count"]
    
    print(f"\nğŸ” Using regex: {pattern}")
    if matches.empty:
        print("âš ï¸ No matches found.")
    else:
        print(matches.head(top_n))
    return pattern  # so you can reuse in apply_tag

def apply_tag(pattern, tag):
    """Apply a tag to matched rows"""
    mask = df["tag"].isna() & df["subject"].str.contains(pattern, flags=re.IGNORECASE, regex=True)
    df.loc[mask, "tag"] = tag
    print(f"âœ… Applied tag '{tag}' to {mask.sum()} rows.")
    progress()

# -------------------------
# Example usage
progress()

# Preview (unique matches only, with counts)
pattern = preview_matches(start="COB -", end="summary", top_n=5)

# Apply tag
apply_tag(pattern, "Sales")

print("\nğŸ“Œ Updated DataFrame:")
print(df)
